<!doctype html>
<html lang="en">
<head>

  <title>ARI CHATBOT DEMO</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
  
  <!-- Bootstrap CSS -->
  <link rel="stylesheet"  href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
  <style>
    body {font-family: Arial, Helvetica, sans-serif;}
* {
  box-sizing: border-box;
}

input[type=text], select{

  width: 100%;
  padding: 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
  resize: vertical; 
}

textarea{
  /* float: left; */
  width: 100%;
  padding: 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
  resize: vertical; 
}

label {
  padding: 12px 12px 12px 0;
  display: inline-block;
}

.submit {
  background-color: #4CAF50;
  color: white;
  padding: 12px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  float: left;
}

.submit:hover {
  background-color: #45a049;
}

.Clear {
  background-color: #4CAF50;
  color: white;
  padding: 12px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  float: left;
  margin-top: -55px;
  margin-left: 100px;
}

.Clear:hover {
  background-color: #45a049;
} 

.input_container {
  border-radius: 5px;
  background-color: #f3f5f0;
  padding: 20px;
}

.container_1 {
  border-radius: 5px;
  background-color: #55554f;
  padding: 20px;
}

.col-25 {
  float: left;
  width: 25%;
  margin-top: 6px;
}

.col-75 {
  float: left;
  width: 75%;
  margin-top: 6px;
}

/* Clear floats after the columns */
.input_row:after {
  content: "";
  display: table;
  clear: both;
}

#myDIV {
  width: 100%;
  padding: 50px 0;
  text-align: left;
  background-color: lightblue;
  margin-top: 20px;
}

#text_res {
  float: left;
  width: 100%;
  padding: 50px 0;
  background-color: lightblue;
  margin-top: 5px;
}

.form-popup {
  display: none;
  position: fixed;
  bottom: 0;
  right: 15px;
  border: 3px solid #f1f1f1;
  z-index: 9;
}

/* Responsive layout - when the screen is less than 600px wide, make the two columns stack on top of each other instead of next to each other */
@media screen and (max-width: 600px) {
  .col-25, .col-75, input[type=submit] {
    width: 100%;
    margin-top: 0;
  }
}

.open-button {
  background-color: #555;
  color: white;
  padding: 16px 20px;
  border: none;
  cursor: pointer;
  opacity: 0.8;
  position: fixed;
  bottom: 23px;
  right: 28px;
  width: 280px;
}

/* The popup chat - hidden by default */
.chat-popup {
  display: none;
  position: fixed;
  bottom: 0;
  right: 15px;
  border: 3px solid #f1f1f1;
  z-index: 9;
}

/* Add styles to the form container */
.form-container {
  max-width: 500px;
  min-height: 500px;
  padding: 10px;
  background-color: white;
}

/* Full-width textarea */
.form-container textarea {
  width: 100%;
  padding: 15px;
  margin: 5px 0 22px 0;
  border: none;
  background: #f1f1f1;
  resize: none;
  min-height: 30px;
}

/* When the textarea gets focus, do something */
.form-container textarea:focus {
  background-color: #ddd;
  outline: none;
}

/* Set a style for the submit/send button */
.form-container .btn {
  background-color: #4CAF50;
  color: white;
  padding: 16px 20px;
  border: none;
  cursor: pointer;
  width: 100%;
  margin-bottom:10px;
  opacity: 0.8;
}

/* Add a red background color to the cancel button */
.form-container .cancel {
  background-color: red;
}

/* Add some hover effects to buttons */
.form-container .btn:hover, .open-button:hover {
  opacity: 1;
}

.botAvatar {
    border-radius: 50%;
    width: 1.5em;
    height: 1.5em;
    float: left;
    margin-left: 5px;
    /* border: 2px solid  #2c53af ; */
}
.clearfix {
  margin-top: 2px;
  margin-bottom: 2px;
}

.botMsg {
    float: left;
    margin-top: 5px;
    background: white;
    color: black;
    box-shadow: 2px 3px 9px 0px #9a82842e;
    margin-left: 0.5em;
    padding: 10px;
    border-radius: 1.5em;
    max-width: 60%;
    min-width: 25%;
    font-size: 13px;
    word-wrap: break-word;
    border-radius: 0 20px 20px 20px;
}

.userAvatar {
    animation: animateElement linear 0.3s;
    animation-iteration-count: 1;
    border-radius: 50%;
    width: 1.5em;
    height: 1.5em;
    float: right;
    margin-right: 5px;
    /* border: 2px solid  #2c53af ; */
}


.userMsg {
    animation: animateElement linear 0.2s;
    animation-iteration-count: 1;
    margin-top: 5px;
    word-wrap: break-word;
    padding: 10px;
    float: right;
    margin-right: 0.5em;
    background: #5a17ee;
    color: white;
    margin-bottom: 0.15em;
    font-size: 13px;
    max-width: 65%;
    min-width: 15%;
    border-radius: 20px 0px 20px 20px;
    box-shadow: 0px 2px 5px 0px #9a828454;
}
  </style>
  <link rel="icon" href="{{url_for('static',filename='style.css')}}">
  <link rel="icon" href="{{url_for('static',filename='imgs/ari.jpg')}}">
  
</head>
<body>
  <!-- <script src="static/script.js"></script>
  -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
  function openForm() {
  document.getElementById("myForm").style.display = "block";
}
$("#send_btn").on("click", function(e) {
  var text  = box_chat.elements.namedItem("message").value;
  console.log("DEBUG text", text);

  if (text == "" || $.trim(text) == "") {
      e.preventDefault();
      return false;
  } else {
      send_message(text, "user123");
      e.preventDefault();
      return false;
  }
})
    
</script>

<div>
  <button class="open-button" onclick="openForm()">Chat</button>

  <div class="chat-popup" id="myForm">
    <form class="form-container" id="form-container" method="POST">
      <h1>Chat with bot</h1>
  
      <label for="message"><b>Message</b></label>
      <div style="overflow-y: scroll; height:300px;" id="text_res" class="text_res">
        <div class="clearfix"></div>
        
      </div>
      <textarea placeholder="Type message.." name="message" required style="height:50px;" id="text_input"></textarea>
       
      <button type="button" class="btn" id="send_btn">Send</button>
      <button type="button" class="btn cancel" onclick="closeForm()" id="close_btn">Close</button>
    </form>
  </div>

</div>
<div class="container">
  <div class="row">
    <div class="col">

      <div class="mb-3 mt-3">

        <h3 class="mb-3" style="font-weight: 100">Upload files</h3>
        <div><b>Upload stories.md, nlu.md, domain.yml</b></div>
        <div class="form-group mb-3">
          <div class="custom-file">
            <input type="file" class="custom-file-input" name="file_input" id="file_input" oninput="input_filename();">
            <label id="file_input_label" class="custom-file-label" for="files">Select file</label>
          </div>  
          <div>
            <button onclick="upload('{{ request.url }}');" id="upload_btn" class="btn btn-primary">Upload</button>
          </div>
        </div>
        <form id="button_form", method="POST">
          <p>
            <input type="submit" value="Train" class="btn btn-primary"  onclick="show_alert('Start training model, please wait for few minutes...', 'success'); javascript:  form.action='/train';">
          </p>
        </form>  
        <p>
          {% with messages = get_flashed_messages() %}
            {% if messages %}
            <ul class=flashes>
            {% for message in messages %}
              <li>{{ message }}</li>
            {% endfor %}
            </ul>
            {% endif %}
          {% endwith %}
        </p> 
        <button class="btn btn-primary d-none" id="loading_btn" type="button" disabled>
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Uploading...
        </button>
        <button type="button" id="cancel_btn" class="btn btn-secondary d-none">Cancel upload</button>
      </div>

      <div id="progress_wrapper" class="d-none">
        <label id="progress_status"></label>
        <div class="progress mb-3">
          <div id="progress" class="progress-bar" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>

      <div id="alert_wrapper"></div>
    </div>
  </div>
</div>

<div id = "input_container" class="input_container">
  <form id = "my_form" method="POST"> 
  <div class="input_row">
    <div class="col-25">
      <label for="sentences">Input sentences</label>
    </div>
    <div class="col-75">
      <textarea id="sentences" name="sentences" placeholder="Write something.." style="height:200px"></textarea>
    </div>
  </div>
  <div class="input_row">
    <div class="col-75">
        <button type="submit" value="Submit" class = "submit">Submit</button>
    </div>

    <div class="col-75">
      <button type="button" value="Clear" onclick="document.getElementById('myDIV').innerHTML = ''" class="Clear">Clear</button>
    </div>
  </div>
</form>

<div style="overflow-y: scroll; height:200px;" id="myDIV" class="myDIV">

</div>
</div>

<script>

// Get a reference to the progress bar, wrapper & status label
var progress = document.getElementById("progress");
var progress_wrapper = document.getElementById("progress_wrapper");
var progress_status = document.getElementById("progress_status");

// Get a reference to the 3 buttons
var upload_btn = document.getElementById("upload_btn");
var loading_btn = document.getElementById("loading_btn");
var cancel_btn = document.getElementById("cancel_btn");

// Get a reference to the alert wrapper
var alert_wrapper = document.getElementById("alert_wrapper");

// Get a reference to the file input element & input label 
var input = document.getElementById("file_input");
var file_input_label = document.getElementById("file_input_label");

// Function to show alerts
function show_alert(message, alert) {

  alert_wrapper.innerHTML = `
    <div id="alert" class="alert alert-${alert} alert-dismissible fade show" role="alert">
      <span>${message}</span>
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
  `
}

// Function to upload file
function upload(url) {

  // Reject if the file input is empty & throw alert
  if (!input.value) {
    show_alert("No file selected", "warning")
    return;
  }

  // Create a new FormData instance
  var data = new FormData();

  // Create a XMLHTTPRequest instance
  var request = new XMLHttpRequest();

  // Set the response type
  request.responseType = "json";

  // Clear any existing alerts
  alert_wrapper.innerHTML = "";

  // Disable the input during upload
  input.disabled = true;

  // Hide the upload button
  upload_btn.classList.add("d-none");

  // Show the loading button
  loading_btn.classList.remove("d-none");

  // Show the cancel button
  cancel_btn.classList.remove("d-none");

  // Show the progress bar
  progress_wrapper.classList.remove("d-none");

  // Get a reference to the file
  var file = input.files[0];

  // Get a reference to the filename
  var filename = file.name;

  // Get a reference to the filesize & set a cookie
  var filesize = file.size;
  document.cookie = `filesize=${filesize}`;

  // Append the file to the FormData instance
  data.append("file", file);

  // request progress handler
  request.upload.addEventListener("progress", function (e) {

    // Get the loaded amount and total filesize (bytes)
    var loaded = e.loaded;
    var total = e.total

    // Calculate percent uploaded
    var percent_complete = (loaded / total) * 100;

    // Update the progress text and progress bar
    progress.setAttribute("style", `width: ${Math.floor(percent_complete)}%`);
    progress_status.innerText = `${Math.floor(percent_complete)}% uploaded`;

  })

  // request load handler (transfer complete)
  request.addEventListener("load", function (e) {

    if (request.status == 200) {

      show_alert(`${request.response.message}`, "success");
    }
    else {
      show_alert(`Error uploading file`, "danger");
    }
    reset();
  });

  // request error handler
  request.addEventListener("error", function (e) {
    reset();
    show_alert(`Error uploading file`, "warning");
  });

  // request abort handler
  request.addEventListener("abort", function (e) {
    reset();
    show_alert(`Upload cancelled`, "primary");
  });

  // Open and send the request
  request.open("post", url);
  request.send(data);

  cancel_btn.addEventListener("click", function () {
    request.abort();
  })
}

// Function to update the input placeholder
function input_filename() {
  file_input_label.innerText = input.files[0].name;
}

// Function to reset the page
function reset() {
  // Clear the input
  input.value = null;

  // Hide the cancel button
  cancel_btn.classList.add("d-none");

  // Reset the input element
  input.disabled = false;

  // Show the upload button
  upload_btn.classList.remove("d-none");

  // Hide the loading button
  loading_btn.classList.add("d-none");

  // Hide the progress bar
  progress_wrapper.classList.add("d-none");

  // Reset the progress bar state
  progress.setAttribute("style", `width: 0%`);

  // Reset the input placeholder
  file_input_label.innerText = "Select file";
}

//------------------------------------------NLU Parse Handler-------------------------------------------
function clear_text(event) {
  console.log("DEBUG event", event.target.id);
  if (event.target.id === "send_btn") {
    // console.log("Hello")
    text_input.value = "";
  }
  else{
    form.elements.namedItem("sentences").value = "";
  }
  return false;
}

function display_pipeline() {
    document.getElementById("myForm").style.display = "block";
}

function closeForm() {
    document.getElementById("myForm").style.display = "none";
}

function logSubmit(event) {
    console.log('DEBUG yes');
    const result = get_input();
    clear_text(event);
    get_reponse_from_rasa(result);
    event.preventDefault();
}

const container = document.getElementById("container");
const form = document.getElementById("my_form"); 
const log = document.getElementById("myDIV");

form.addEventListener("submit", logSubmit); 

function get_input(){
    const text = form.elements.namedItem("sentences").value;
    console.log("DEBUG  text", text);
    return text;
}

function get_reponse_from_rasa(text){

    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            //custom action to process this.responseText
            var response = xhttp.responseText
            var json = JSON.parse(response)
            console.log('DEBUG json', json)
            log.innerHTML=""
            for (x in json){
              log.innerHTML += "<b>" + x +"</b>" + ":";
              log.innerHTML += JSON.stringify(json[x]) + "<br>";
              log.innerHTML += "<br>"
            }
        }
  };

    xhttp.open("POST", "http://18.139.121.226:5005/model/parse");
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.send(JSON.stringify({text: text}));
};

//---------------------------------------Chat box Handler----------------------------------------

const content = document.getElementById("text_res");
const text_input = document.getElementById("text_input");
const box_chat = document.getElementById("form-container");

$("#send_btn").on("click", function(e) {
  var text  = box_chat.elements.namedItem("message").value;
  console.log("DEBUG text", text);

  if (text == "" || $.trim(text) == "") {
      e.preventDefault();
      return false;
  } else {
      send_message(text, "user123");
      clear_text(e);
      e.preventDefault();
      return false;
  }
})

function setUserResponse(message) {
  var UserResponse = '<img class="userAvatar" src=' + "static/img/userAvatar.jpg" + '><p class="userMsg">' + message + ' </p><div class="clearfix"></div>';
  $(UserResponse).appendTo(".chats").show("slow");

  $(".usrInput").val("");
  scrollToBottomOfResults();
  showBotTyping();
  $(".suggestions").remove();
};

function display_response(res) {  
  if (res.length < 1){
    var fallbackMsg = "I am facing some issues, please try again";
    content.innerHTML += '<img class = "botAvatar" src="static/imgs/botAvatar.png"/>' + '<p class="botMsg">' + fallbackMsg + '</p><div class="clearfix"></div>';
  }
  else{
    for (i = 0; i < res.length; i++) {
      if (res[i].hasOwnProperty("text")) {
        content.innerHTML += '<img class = "botAvatar" src="static/imgs/botAvatar.png"/>' + '<p class="botMsg">' + res[i].text + '</p><div class="clearfix"></div>';
      }
      else if (res[i].hasOwnProperty("image")) {
        
      }
    };
  }
  return false;
}

function send_message(message, user_id) {
  content.innerHTML += "<b>User</b>:" + message + "<br>";
  console.log(user_id)
  $.ajax({
    url: "http://18.139.121.226:5005/webhooks/rest/webhook",
    type: "POST", 
    contentType: "application/json",
    data: JSON.stringify({message: message, sender: user_id}),
    crossDomain: true,
    success: function(botResponse, status) {
        console.log("Response from Rasa: ", botResponse, "\nStatus: ", status);
        display_response(botResponse);
    },
    error: function(xhr, textStatus, errorThrown) {
      console.log("Error from bot end: ", textStatus);
    }
  });
  return false;
}

function openForm() {
  document.getElementById("myForm").style.display = "block";
}

function closeForm() {
  document.getElementById("myForm").style.display = "none";
}</script>
</body>
</html>
